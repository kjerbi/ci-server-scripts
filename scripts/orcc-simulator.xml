<!--
These tasks must be launched after orcc-build, to ensure eclipse used for runtime is correctly configured.
Orcc and graphiti plugins must have been installed before executing this routine.

Properties calProject, backendType and topNetwork must be specified to launch properly :
	calProject : name of project to compile & run (RVC, System, etc.)
	topNetwork : complete name of the top network (org.mpeg4.part2.Top_RVC, etc.)
	inputStimulus : sequence to decode with the application
-->
<project name="Headless Orcc simulation" default="run">

	<!-- This ant build file use "ant-contrib" library. See http://ant-contrib.sourceforge.net/
	or simply install it with your system package manager -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" />

	<!-- Load properties file -->
	<property file="headless-config.properties" />

	<target name="run" depends="clean-workspace, init, setup-workspace, frontend-exec, simulator-exec" />

	<target name="init">
		<if>
			<not>
				<and>
					<isset property="calProject" />
					<isset property="topNetwork" />
					<isset property="inputStimulus" />
				</and>
			</not>
			<then>
				<fail>You must specify properties calProject, topNetwork and inputStimulus</fail>
			</then>
		</if>

		<delete dir="${path.output.apps}/${target.subfolder}/${topNetwork}" failonerror="false" />
	</target>

	<target name="setup-workspace" depends="init">
		<mkdir dir="${eclipse.runtime.workspace}" />
		<exec executable="${eclipse.runtime.root}/eclipse" failonerror="true">
			<arg value="-nosplash" />
			<arg value="-consoleLog" />
			<arg value="-data" />
			<arg value="${eclipse.runtime.workspace}" />
			<arg value="-application" />
			<arg value="net.sf.orcc.cal.workspaceSetup" />
			<arg value="${path.svn.checkout}/orc-apps/" />
		</exec>
	</target>

	<target name="frontend-exec" depends="setup-workspace">
		<exec executable="${eclipse.runtime.root}/eclipse" failonerror="true">
			<arg value="-nosplash" />
			<arg value="-consoleLog" />
			<arg value="-data" />
			<arg value="${eclipse.runtime.workspace}" />
			<arg value="-application" />
			<arg value="net.sf.orcc.cal.cli" />
			<arg value="${calProject}" />
			<arg value="-vmargs" />
			<arg value="-Xms40m" />
			<arg value="-Xmx768m" />
		</exec>
	</target>

	<target name="simulator-exec" depends="setup-workspace, frontend-exec">
		<exec executable="${eclipse.runtime.root}/eclipse" failonerror="true">
			<arg value="-nosplash" />
			<arg value="-consoleLog" />
			<arg value="-data" />
			<arg value="${eclipse.runtime.workspace}" />
			<arg value="-application" />
			<arg value="net.sf.orcc.simulators.cli" />
			<arg value="-n" />
			<arg value="-i" />
			<arg value="${inputStimulus}" />
			<arg value="-p" />
			<arg value="${calProject}" />
			<!--arg value="-ref" />
			<arg value="${path.output.apps}/${target.subfolder}/${topNetwork}" /-->
			<arg value="${topNetwork}" />
			<arg value="-vmargs" />
			<arg value="-Xms40m" />
			<arg value="-Xmx768m" />
		</exec>
	</target>

	<target name="clean-workspace">
		<delete dir="${eclipse.runtime.workspace}" />
	</target>

</project>